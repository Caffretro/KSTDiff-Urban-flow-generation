# KSTDiff-Urban-flow-generation 代码流程说明

## 概述

KSTDiff（Knowledge-enhanced Spatio-Temporal Diffusion）是一个基于扩散模型的城市流量生成框架。该框架通过结合城市知识图谱和去噪扩散概率模型，生成真实的城市流量数据。整个流程分为三个主要步骤：

1. **预训练城市知识图谱嵌入**
2. **训练扩散模型**
3. **生成城市流量图**

本文档以 NYC（纽约）数据集为例，详细介绍每个步骤的代码流程。

## 数据结构说明

每个数据集（如 `data_nyc`）包含以下文件：

- `alldayflow.json`: 所有天的流量数据，格式为 {日期: nreg×nhour×2 的流量矩阵}
- `kg.txt`: 知识图谱三元组，格式为 "头实体\t 关系\t 尾实体"
- `region2info.json`: 区域信息，包含每个区域的特征向量
- `train_regs.json`: 训练区域列表
- `test_regs.json`: 测试区域列表
- `ER.npz`: 预训练的实体嵌入（第一步生成）

## 步骤一：预训练城市知识图谱

**命令**：`bash pretrain.sh`

### 主要流程（main_pretrain.py）

#### 1. 数据加载（load_data_pretrain.py）

```python
Data.__init__()
├── load_reg() # 加载区域信息
│   ├── 读取 region2info.json
│   └── 创建区域ID映射 reg2id
└── load_kg() # 加载知识图谱
    ├── 读取 kg.txt 文件
    ├── 构建实体ID映射 ent2id
    ├── 构建关系ID映射 rel2id
    └── 将文本三元组转换为ID形式
```

#### 2. 模型构建（model_pretrain.py）

```python
TuckER模型
├── 实体嵌入层 E: nn.Embedding(实体数, 嵌入维度)
├── 关系嵌入层 R: nn.Embedding(关系数, 嵌入维度)
├── 核心张量 W: 三维参数张量
└── 正则化层: Dropout, BatchNorm
```

#### 3. 训练流程

```python
Experiment.train_and_eval()
├── 构建TuckER模型
├── 准备训练数据
│   └── get_er_vocab(): 构建(头实体,关系)->尾实体的映射
└── 训练循环（num_iterations轮）
    ├── 随机打乱训练对
    ├── 批量训练
    │   ├── get_batch(): 获取批次数据和目标
    │   ├── model.forward(): 前向传播
    │   │   ├── 获取头实体嵌入 h
    │   │   ├── 获取关系嵌入 r
    │   │   ├── 计算 W 矩阵变换
    │   │   └── 预测尾实体分布
    │   └── 计算损失并反向传播
    └── 保存实体嵌入到 ER.npz
```

**输出**：`ER.npz` 文件，包含预训练的实体嵌入矩阵

## 步骤二：训练扩散模型

**命令**：`bash train.sh`

### 主要流程（main.py）

#### 1. 数据加载（load_data.py）

```python
Data.__init__()
├── load_reg() # 加载区域信息和训练/测试划分
│   ├── 读取 region2info.json
│   ├── 读取 train_regs.json 和 test_regs.json
│   └── 提取区域特征 regfeas
├── load_kg() # 加载完整和子图知识图谱
│   ├── 构建完整KG: kg_data
│   ├── 构建训练子图: trainkg_data（只包含训练区域）
│   └── 构建采样子图: samplekg_data（只包含测试区域）
├── load_flow() # 加载流量数据
│   ├── 读取 alldayflow.json
│   ├── 筛选工作日数据
│   └── 归一化到 [-1, 1]
└── load_pretrain() # 加载预训练嵌入
    ├── 读取 ER.npz
    └── 准备条件预测模型的输入数据
```

#### 2. 模型构建

```python
Experiment.train_and_eval()
├── 构建图结构
│   ├── build_graph(): 将KG转换为PyTorch Geometric格式
│   │   ├── g: 完整知识图谱
│   │   ├── g_train: 训练区域子图
│   │   └── g_samp: 测试区域子图
├── 构建KGFlow模型（model.py）
│   ├── 实体嵌入层（使用预训练权重）
│   ├── 时间位置编码 SinusoidalPosEmb
│   ├── RGCN层处理知识图谱
│   └── Self-Attention层处理时空特征
├── 构建条件预测模型 DeterministicFeedForwardNeuralNetwork
│   └── 预测区域的平均流量作为引导信号
└── 构建扩散模型 GaussianDiffusion
    ├── 设置扩散过程参数（beta schedule, timesteps）
    ├── 包装KGFlow作为去噪网络
    └── 集成条件预测模型
```

#### 3. 训练流程

```python
训练循环（num_iterations轮）
├── 预训练条件预测模型
│   └── train_guidance_model(): 学习区域特征到平均流量的映射
├── 训练扩散模型
│   ├── get_batch(): 获取流量数据批次
│   ├── diffusion.forward(): 扩散模型前向传播
│   │   ├── q_sample(): 添加噪声得到 x_t
│   │   ├── model(): 预测噪声
│   │   │   ├── 时间嵌入编码
│   │   │   ├── RGCN处理知识图谱
│   │   │   ├── Self-Attention处理时空特征
│   │   │   └── 输出噪声预测
│   │   └── 计算去噪损失
│   └── 反向传播更新参数
├── 定期更新条件预测模型
└── 定期保存模型和生成样本
```

**输出**：

- `model_{epoch}.pth`: 训练好的扩散模型
- `sample_{epoch}.npz`: 中间生成的样本

## 步骤三：生成城市流量

**命令**：`bash sample.sh`

### 主要流程（main_sample.py）

#### 1. 模型加载

```python
Experiment.train_and_eval()
├── 加载数据和图结构（同训练阶段）
├── 构建模型架构（同训练阶段）
└── 加载训练好的模型权重
    └── diffusion.load_state_dict(torch.load(model_path))
```

#### 2. 生成流程

```python
采样生成
├── 计算生成批次数
│   └── 根据训练数据量确定需要生成的样本数
└── 批量生成
    └── diffusion.sample()
        ├── 初始化随机噪声 x_T ~ N(0, I)
        ├── DDIM采样循环（从T到0）
        │   ├── model_predictions(): 预测噪声和x_0
        │   │   ├── compute_guiding_prediction(): 计算条件引导
        │   │   ├── model(): 去噪网络预测
        │   │   └── predict_start_from_noise(): 从噪声预测x_0
        │   ├── 计算x_{t-1}的分布参数
        │   └── 采样得到x_{t-1}
        └── 返回生成的流量数据
```

#### 3. 关键函数说明

```python
GaussianDiffusion.sample()
├── ddim_sample(): DDIM加速采样
│   ├── 设置采样时间步
│   └── 逐步去噪
└── p_sample_loop(): 标准DDPM采样
    ├── 从纯噪声开始
    └── 逐步应用p_sample去噪

p_sample() # 单步去噪
├── p_mean_variance(): 计算去噪分布参数
│   ├── model_predictions(): 模型预测
│   └── q_posterior(): 计算后验分布
└── 添加噪声（除最后一步）

compute_guiding_prediction() # 条件引导
├── 使用条件预测模型
└── 预测区域平均流量作为引导信号
```

**输出**：`sample_{epoch}_final.npz` - 最终生成的城市流量数据

## 步骤四：评估（evaluate.py）

评估生成质量的指标：

- **MAE**: 平均绝对误差
- **RMSE**: 均方根误差
- **SMAPE**: 对称平均绝对百分比误差
- **MMD**: 最大均值差异（衡量分布相似度）

## 关键设计特点

1. **知识增强**：通过预训练的知识图谱嵌入，模型能够理解区域之间的空间关系和语义联系。

2. **条件生成**：使用条件预测模型提供额外的引导信号，确保生成的流量符合区域特征。

3. **图神经网络**：使用 RGCN 处理异构知识图谱，有效建模多种类型的区域关系。

4. **时空建模**：结合 Self-Attention 机制处理时空依赖关系。

5. **扩散模型**：利用去噪扩散概率模型的强大生成能力，生成高质量的城市流量数据。

## 使用建议

1. **数据准备**：确保数据格式正确，特别是知识图谱的构建质量直接影响模型性能。

2. **超参数调整**：

   - 预训练：调整嵌入维度(edim)和学习率
   - 扩散模型：调整扩散步数(diffusion_steps)和网络深度(n_layer)
   - 条件引导：调整更新频率(train_guidance_every_epochs)

3. **计算资源**：模型训练需要 GPU 支持，建议使用显存>=16GB 的 GPU。

4. **生成质量**：可以通过调整采样步数和引导强度来平衡生成速度和质量。
